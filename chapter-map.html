<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map - NSA Network</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="chapter-map.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="home.html">NSA Directory</a>
            </div>
            <div class="nav-menu">
                <a href="home.html" class="nav-link">Home</a>
                <a href="about.html" class="nav-link">About</a>
                <a href="contact.html" class="nav-link">Contact</a>
            </div>
            <div class="hamburger" onclick="toggleSidebar()" title="Open Menu">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">NSA Network</h3>
            <button class="sidebar-close" onclick="toggleSidebar()">
                <i class="fas fa-times"></i>
            </button>
        </div>
                <ul class="sidebar-menu">
            <li class="sidebar-item">
                <a href="search.html" class="sidebar-link">
                    <i class="fas fa-search"></i>
                    Find NSA
                </a>
            </li>
            <li class="sidebar-item">
                <a href="chapter-map.html" class="sidebar-link">
                    <i class="fas fa-map"></i>
                    Interactive Map
                </a>
            </li>
            <li class="sidebar-item">
                <a href="events.html" class="sidebar-link">
                    <i class="fas fa-calendar-alt"></i>
                    Events Hub
                </a>
            </li>
            <li class="sidebar-item">
                <a href="alumni.html" class="sidebar-link">
                    <i class="fas fa-user-graduate"></i>
                    Alumni Spotlight
                </a>
            </li>
            <li class="sidebar-item">
                <a href="scholarships.html" class="sidebar-link">
                    <i class="fas fa-award"></i>
                    Scholarships
                </a>
            </li>
            <li class="sidebar-item">
                <a href="mentorship.html" class="sidebar-link">
                    <i class="fas fa-hands-helping"></i>
                    Mentorship
                </a>
            </li>
            <li class="sidebar-item">
                <a href="resources.html" class="sidebar-link">
                    <i class="fas fa-book"></i>
                    Resource Center
                </a>
            </li>
            <li class="sidebar-item">
                <a href="news.html" class="sidebar-link">
                    <i class="fas fa-newspaper"></i>
                    News & Updates
                </a>
            </li>
            <li class="sidebar-item">
                <a href="donation.html" class="sidebar-link">
                    <i class="fas fa-hand-holding-heart"></i>
                    Donation & Help
                </a>
            </li>
            <li class="sidebar-item">
                <a href="volunteer.html" class="sidebar-link">
                    <i class="fas fa-heart"></i>
                    Volunteer Board
                </a>
            </li>
            <li class="sidebar-item">
                <a href="marketplace.html" class="sidebar-link">
                    <i class="fas fa-store"></i>
                    Marketplace
                </a>
            </li>
        </ul>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <main>
        <!-- Hero Section -->
        <section class="chapter-map-hero">
            <div class="hero-background">
                <div class="hero-pattern"></div>
            </div>
            <div class="container">
                <div class="hero-content">
                    <div class="hero-text">
                        <h1 class="hero-title">
                            Interactive <span class="highlight">NSA Map</span>
                        </h1>
                        <p class="hero-description">
                            Find and connect with Nepalese Student Associations at universities nationwide. 
                            Explore our interactive map to discover NSA chapters, their locations, and contact information.
                        </p>
                        <div class="hero-stats">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="stat-number" id="totalStates">0</span>
                                    <span class="stat-label">States</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-university"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="stat-number" id="totalUniversities">0</span>
                                    <span class="stat-label">Universities</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="stat-number" id="totalChapters">0</span>
                                    <span class="stat-label">NSA Chapters</span>
                                </div>
                            </div>
                        </div>
                        <div class="hero-actions">
                            <button class="btn btn-primary btn-large" onclick="openChapterForm()">
                                <i class="fas fa-plus"></i>
                                Submit Your Chapter
                            </button>

                        </div>
                    </div>
                    <div class="hero-visual">
                        <div class="floating-elements">
                            <div class="floating-card" data-delay="0">
                                <i class="fas fa-map"></i>
                                <span>Interactive Map</span>
                            </div>
                            <div class="floating-card" data-delay="1">
                                <i class="fas fa-search"></i>
                                <span>Find Chapters</span>
                            </div>
                            <div class="floating-card" data-delay="2">
                                <i class="fas fa-connectdevelop"></i>
                                <span>Connect</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Map Section -->
        <section class="map-section">
            <div class="container">
                <div class="map-layout">
                    <!-- Search and Filter Sidebar -->
                    <aside class="map-sidebar">
                        <div class="sidebar-header">
                            <h3>Search & Filter</h3>
                            <button class="reset-filters" onclick="resetFilters()">
                                <i class="fas fa-refresh"></i>
                                Reset
                            </button>
                        </div>
                        
                        <div class="search-filters">
                            <div class="search-group">
                                <label for="chapterSearch">Search Chapters</label>
                                <div class="search-input-wrapper">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="chapterSearch" placeholder="Search by university or city...">
                                </div>
                            </div>
                            
                            <div class="filter-group">
                                <label for="stateFilter">Filter by State</label>
                                <select id="stateFilter">
                                    <option value="">All States</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="universityFilter">Filter by University</label>
                                <select id="universityFilter">
                                    <option value="">All Universities</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="sortFilter">Sort By</label>
                                <select id="sortFilter">
                                    <option value="name">Name A-Z</option>
                                    <option value="state">State</option>
                                    <option value="university">University</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="results-info">
                            <span id="filteredResults">0</span> chapters found
                        </div>
                        
                        <div class="map-legend">
                            <h4>Map Legend</h4>
                            <div class="legend-items">
                                <div class="legend-item">
                                    <div class="legend-marker active"></div>
                                    <span>Active Chapter</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-marker featured"></div>
                                    <span>Featured Chapter</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-marker new"></div>
                                    <span>Recently Added</span>
                                </div>
                            </div>
                        </div>
                    </aside>

                    <!-- Interactive Map -->
                    <div class="map-container">
                        <div id="chapterMap" class="chapter-map"></div>
                        <div class="map-controls">
                            <button class="map-control-btn" onclick="resetMapView()" title="Reset Map View">
                                <i class="fas fa-home"></i>
                            </button>
                            <button class="map-control-btn" onclick="toggleFullscreen()" title="Fullscreen">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Call to Action Section -->
        <section class="chapter-cta">
            <div class="container">
                <div class="cta-content">
                    <div class="cta-text">
                        <h2>Don't See Your Chapter?</h2>
                        <p>Help us grow the NSA network by adding your chapter information. Join hundreds of other Nepali student associations across the United States.</p>
                        <div class="cta-features">
                            <div class="cta-feature">
                                <i class="fas fa-plus-circle"></i>
                                <span>Easy Submission</span>
                            </div>
                            <div class="cta-feature">
                                <i class="fas fa-users"></i>
                                <span>Connect with Students</span>
                            </div>
                            <div class="cta-feature">
                                <i class="fas fa-share"></i>
                                <span>Share Your Events</span>
                            </div>
                        </div>
                    </div>
                    <div class="cta-action">
                        <button class="btn btn-primary btn-large" onclick="openChapterForm()">
                            <i class="fas fa-plus"></i>
                            Submit Your Chapter
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Chapter Detail Modal -->
    <div class="modal" id="chapterModal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 id="modalChapterName">Chapter Details</h3>
                <button class="close-modal" id="closeChapterModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalChapterBody">
                <!-- Chapter details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Submit Chapter Modal -->
    <div class="modal" id="submitChapterModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Submit Your Chapter</h3>
                <button class="close-modal" id="closeSubmitModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="chapterForm" class="chapter-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="chapterName">Chapter Name *</label>
                            <input type="text" id="chapterName" name="chapterName" required>
                        </div>
                        <div class="form-group">
                            <label for="universityName">University Name *</label>
                            <input type="text" id="universityName" name="universityName" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City *</label>
                            <input type="text" id="city" name="city" required>
                        </div>
                        <div class="form-group">
                            <label for="state">State *</label>
                            <select id="state" name="state" required>
                                <option value="">Select State</option>
                                <option value="AL">Alabama</option>
                                <option value="AK">Alaska</option>
                                <option value="AZ">Arizona</option>
                                <option value="AR">Arkansas</option>
                                <option value="CA">California</option>
                                <option value="CO">Colorado</option>
                                <option value="CT">Connecticut</option>
                                <option value="DE">Delaware</option>
                                <option value="FL">Florida</option>
                                <option value="GA">Georgia</option>
                                <option value="HI">Hawaii</option>
                                <option value="ID">Idaho</option>
                                <option value="IL">Illinois</option>
                                <option value="IN">Indiana</option>
                                <option value="IA">Iowa</option>
                                <option value="KS">Kansas</option>
                                <option value="KY">Kentucky</option>
                                <option value="LA">Louisiana</option>
                                <option value="ME">Maine</option>
                                <option value="MD">Maryland</option>
                                <option value="MA">Massachusetts</option>
                                <option value="MI">Michigan</option>
                                <option value="MN">Minnesota</option>
                                <option value="MS">Mississippi</option>
                                <option value="MO">Missouri</option>
                                <option value="MT">Montana</option>
                                <option value="NE">Nebraska</option>
                                <option value="NV">Nevada</option>
                                <option value="NH">New Hampshire</option>
                                <option value="NJ">New Jersey</option>
                                <option value="NM">New Mexico</option>
                                <option value="NY">New York</option>
                                <option value="NC">North Carolina</option>
                                <option value="ND">North Dakota</option>
                                <option value="OH">Ohio</option>
                                <option value="OK">Oklahoma</option>
                                <option value="OR">Oregon</option>
                                <option value="PA">Pennsylvania</option>
                                <option value="RI">Rhode Island</option>
                                <option value="SC">South Carolina</option>
                                <option value="SD">South Dakota</option>
                                <option value="TN">Tennessee</option>
                                <option value="TX">Texas</option>
                                <option value="UT">Utah</option>
                                <option value="VT">Vermont</option>
                                <option value="VA">Virginia</option>
                                <option value="WA">Washington</option>
                                <option value="WV">West Virginia</option>
                                <option value="WI">Wisconsin</option>
                                <option value="WY">Wyoming</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="chapterDescription">Chapter Description</label>
                        <textarea id="chapterDescription" name="description" rows="4" placeholder="Tell us about your chapter, activities, and mission..."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="contactEmail">Contact Email</label>
                            <input type="email" id="contactEmail" name="email">
                        </div>
                        <div class="form-group">
                            <label for="contactPhone">Contact Phone</label>
                            <input type="tel" id="contactPhone" name="phone">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="instagram">Instagram</label>
                            <input type="url" id="instagram" name="instagram" placeholder="https://instagram.com/...">
                        </div>
                        <div class="form-group">
                            <label for="facebook">Facebook</label>
                            <input type="url" id="facebook" name="facebook" placeholder="https://facebook.com/...">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="website">Website</label>
                            <input type="url" id="website" name="website" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="linkedin">LinkedIn</label>
                            <input type="url" id="linkedin" name="linkedin" placeholder="https://linkedin.com/...">
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeChapterForm()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit Chapter</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="nsa-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-logo">
                        <i class="fas fa-users"></i>
                        <span>NSA Network</span>
                    </div>
                    <p>Connecting Nepali students across American universities</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="home.html">Home</a></li>
                        <li><a href="search.html">Find NSA</a></li>
                        <li><a href="chapter-map.html">Chapter Map</a></li>
                        <li><a href="about.html">About</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Connect</h4>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-linkedin"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 NSA Network. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Floating AI Search Button -->
    <div class="ai-search-float" onclick="window.location.href='ai-search.html'" title="AI Search">
        <i class="fas fa-robot"></i>
    </div>

    <style>
        .ai-search-float {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            animation: pulse 2s infinite;
        }

        .ai-search-float:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .ai-search-float i {
            color: white;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        .ai-search-float:hover i {
            animation: bounce 0.6s ease;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            }
            50% {
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.7);
            }
            100% {
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            }
        }

        @keyframes bounce {
            0%, 20%, 60%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            80% {
                transform: translateY(-5px);
            }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .ai-search-float {
                width: 50px;
                height: 50px;
                bottom: 15px;
                right: 15px;
            }
            
            .ai-search-float i {
                font-size: 20px;
            }
        }
    </style>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="nav-updater.js"></script>
    <script>
        // Load NSA data and initialize map
        let nsaData = [];
        let filteredData = [];
        let map = null;
        let markersLayer = null;

        async function loadNSAData() {
            try {
                const response = await fetch('nsa_data.json');
                nsaData = await response.json();
                filteredData = [...nsaData];
                
                updateStats();
                populateFilters();
                initializeMap();
                
            } catch (error) {
                console.error('Error loading NSA data:', error);
            }
        }

        function updateStats() {
            const totalChapters = nsaData.length;
            const states = [...new Set(nsaData.map(nsa => {
                const location = nsa.location || '';
                const parts = location.split(',');
                return parts[parts.length - 1]?.trim();
            }).filter(Boolean))];
            const universities = [...new Set(nsaData.map(nsa => nsa.university))];
            
            document.getElementById('totalChapters').textContent = totalChapters;
            document.getElementById('totalStates').textContent = states.length;
            document.getElementById('totalUniversities').textContent = universities.length;
        }

        function populateFilters() {
            const states = [...new Set(nsaData.map(nsa => {
                const location = nsa.location || '';
                const parts = location.split(',');
                return parts[parts.length - 1]?.trim();
            }).filter(Boolean))].sort();
            
            const stateFilter = document.getElementById('stateFilter');
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateFilter.appendChild(option);
            });
        }

        function initializeMap() {
            map = L.map('chapterMap').setView([39.8283, -98.5795], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            markersLayer = L.layerGroup().addTo(map);

            // Once the map is ready, add markers for all chapters
            renderMarkers(nsaData);
        }

        // Simple US state centroid fallbacks (lat, lng)
        const stateCentroids = {
            "Alabama": [32.806671, -86.791130], "Alaska": [61.370716, -152.404419], "Arizona": [33.729759, -111.431221],
            "Arkansas": [34.969704, -92.373123], "California": [36.116203, -119.681564], "Colorado": [39.059811, -105.311104],
            "Connecticut": [41.597782, -72.755371], "Delaware": [39.318523, -75.507141], "Florida": [27.766279, -81.686783],
            "Georgia": [33.040619, -83.643074], "Hawaii": [21.094318, -157.498337], "Idaho": [44.240459, -114.478828],
            "Illinois": [40.349457, -88.986137], "Indiana": [39.849426, -86.258278], "Iowa": [42.011539, -93.210526],
            "Kansas": [38.526600, -96.726486], "Kentucky": [37.668140, -84.670067], "Louisiana": [31.169546, -91.867805],
            "Maine": [44.693947, -69.381927], "Maryland": [39.063946, -76.802101], "Massachusetts": [42.230171, -71.530106],
            "Michigan": [43.326618, -84.536095], "Minnesota": [45.694454, -93.900192], "Mississippi": [32.741646, -89.678696],
            "Missouri": [38.456085, -92.288368], "Montana": [46.921925, -110.454353], "Nebraska": [41.125370, -98.268082],
            "Nevada": [38.313515, -117.055374], "New Hampshire": [43.452492, -71.563896], "New Jersey": [40.298904, -74.521011],
            "New Mexico": [34.840515, -106.248482], "New York": [42.165726, -74.948051], "North Carolina": [35.630066, -79.806419],
            "North Dakota": [47.528912, -99.784012], "Ohio": [40.388783, -82.764915], "Oklahoma": [35.565342, -96.928917],
            "Oregon": [44.572021, -122.070938], "Pennsylvania": [40.590752, -77.209755], "Rhode Island": [41.680893, -71.511780],
            "South Carolina": [33.856892, -80.945007], "South Dakota": [44.299782, -99.438828], "Tennessee": [35.747845, -86.692345],
            "Texas": [31.054487, -97.563461], "Utah": [40.150032, -111.862434], "Vermont": [44.045876, -72.710686],
            "Virginia": [37.769337, -78.169968], "Washington": [47.400902, -121.490494], "West Virginia": [38.491226, -80.954453],
            "Wisconsin": [44.268543, -89.616508], "Wyoming": [42.755966, -107.302490]
        };

        function extractState(locationText) {
            if (!locationText) return null;
            const parts = locationText.split(',');
            const last = parts[parts.length - 1]?.trim();
            if (!last) return null;
            // Normalize state name capitalization
            return last;
        }

        function getGeocodeCache() {
            try {
                return JSON.parse(localStorage.getItem('nsaGeocodeCache') || '{}');
            } catch (_) {
                return {};
            }
        }

        function setGeocodeCache(cache) {
            try {
                localStorage.setItem('nsaGeocodeCache', JSON.stringify(cache));
            } catch (_) {}
        }

        async function geocode(query) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=us&q=${encodeURIComponent(query)}`;
            const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
            if (!res.ok) throw new Error('Geocoding failed');
            const data = await res.json();
            if (!Array.isArray(data) || data.length === 0) return null;
            const item = data[0];
            return { lat: parseFloat(item.lat), lon: parseFloat(item.lon) };
        }

        async function getCoordinatesForNSA(nsa) {
            const cache = getGeocodeCache();
            const key = `${nsa.university || nsa.name} | ${nsa.location || ''}`.trim();
            if (cache[key]) return cache[key];

            // Try geocoding with university + location first
            let coords = null;
            const queries = [];
            if (nsa.university && nsa.location) queries.push(`${nsa.university}, ${nsa.location}, USA`);
            if (nsa.location) queries.push(`${nsa.location}, USA`);
            if (nsa.university) queries.push(`${nsa.university}, USA`);

            for (const q of queries) {
                try {
                    coords = await geocode(q);
                    if (coords) break;
                } catch (_) {}
                // Be polite to the geocoding service
                await new Promise(r => setTimeout(r, 400));
            }

            // Fallback to state centroid if needed
            if (!coords) {
                const state = extractState(nsa.location || '');
                if (state && stateCentroids[state]) {
                    const [lat, lon] = stateCentroids[state];
                    coords = { lat, lon };
                }
            }

            if (coords) {
                cache[key] = coords;
                setGeocodeCache(cache);
                return coords;
            }

            return null;
        }

        function buildPopupHtml(nsa) {
            const instagram = nsa.instagram ? `<a href="${nsa.instagram}" target="_blank" style="margin-right:8px;color:#C13584"><i class='fab fa-instagram'></i></a>` : '';
            const facebook = nsa.facebook ? `<a href="${nsa.facebook}" target="_blank" style="margin-right:8px;color:#1877f2"><i class='fab fa-facebook'></i></a>` : '';
            const email = nsa.email ? `<a href="mailto:${nsa.email}" style="color:#10b981"><i class='fas fa-envelope'></i></a>` : '';
            return `
                <div style="min-width:220px;">
                    <div style="font-weight:700;font-size:16px;margin-bottom:4px;">${nsa.name || 'NSA Chapter'}</div>
                    <div style="color:#4b5563;margin-bottom:6px;">${nsa.university || ''}</div>
                    <div style="color:#6b7280;margin-bottom:10px;"><i class="fas fa-map-marker-alt" style="color:#ef4444"></i> ${nsa.location || 'Location not specified'}</div>
                    <div>${instagram}${facebook}${email}</div>
                </div>
            `;
        }

        async function renderMarkers(list) {
            if (!map || !markersLayer) return;
            markersLayer.clearLayers();

            let count = 0;
            for (const nsa of list) {
                const coords = await getCoordinatesForNSA(nsa);
                if (!coords) continue;
                const marker = L.marker([coords.lat, coords.lon]);
                marker.bindPopup(buildPopupHtml(nsa));
                markersLayer.addLayer(marker);
                count++;
                // Small delay to avoid hammering the geocoder when uncached
                await new Promise(r => setTimeout(r, 150));
            }
            const resultsEl = document.getElementById('filteredResults');
            if (resultsEl) resultsEl.textContent = count;
        }

        function openChapterForm() {
            document.getElementById('chapterModal').style.display = 'block';
        }

        function closeChapterForm() {
            document.getElementById('chapterModal').style.display = 'none';
        }

        function resetFilters() {
            document.getElementById('chapterSearch').value = '';
            document.getElementById('stateFilter').value = '';
            document.getElementById('universityFilter').value = '';
        }

        document.addEventListener('DOMContentLoaded', loadNSAData);
    </script>
</body>
</html> 